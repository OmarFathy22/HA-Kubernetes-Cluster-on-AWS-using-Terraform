- name: "=== PHASE 1: Prepare All Nodes ==="
  hosts: k8s_cluster
  become: true
  gather_facts: true      # changed it to true
  tags:
    - prepare
    - always
  roles:
    - role: common
      tags: common

- name: "=== PHASE 2: Initialize First Master (Leader) ==="
  hosts: masters[0]
  become: true
  gather_facts: false
  tags:
    - masters
    - init
  roles:
    - role: kubernetes-master
      vars:
        master_init_mode: "leader"
      tags: master-init

- name: "=== PHASE 3: Join Additional Masters ==="
  hosts: masters[1:]
  become: true
  gather_facts: false
  serial: 1  # Join one master at a time
  tags:
    - masters
    - join
  roles:
    - role: kubernetes-master
      vars:
        master_init_mode: "follower"
      tags: master-join

- name: "=== PHASE 4: Join Worker Nodes ==="
  hosts: workers
  become: true
  gather_facts: false
  serial: 2  # Join two workers at a time
  tags:
    - workers
  roles:
    - role: kubernetes-worker
      tags: worker-join
      
- name: "=== PHASE 5: Deploy Add-ons ==="
  hosts: masters[0]
  become: true
  tags:
    - addons
    - headlamp
  roles:
    - role: headlamp

- name: "=== FINAL: Cluster Verification ==="
  hosts: masters[0]
  become: true
  gather_facts: false
  tags:
    - verify
    - always
  tasks:
    - name: Wait for all nodes to be ready
      shell: kubectl get nodes --no-headers | grep -v NotReady | wc -l
      register: ready_nodes
      until: ready_nodes.stdout|int == groups['k8s_cluster']|length
      retries: 30
      delay: 10
      changed_when: false

    - name: Display cluster status
      shell: kubectl get nodes 
      register: cluster_status
      changed_when: false

    - name: Get Headlamp Admin Token
      shell: kubectl -n kube-system get secret headlamp-admin-token -o jsonpath='{.data.token}' | base64 -d
      register: headlamp_token
      changed_when: false
      ignore_errors: true

    - name: Save Headlamp Token to file (remote)
      copy:
        content: "{{ headlamp_token.stdout }}"
        dest: "/tmp/headlamp_token.txt"
        mode: '0600'
      changed_when: false

    - name: Fetch Headlamp Token to Controller
      fetch:
        src: "/tmp/headlamp_token.txt"
        dest: "{{ playbook_dir }}/../headlamp_token.txt"
        flat: yes
      changed_when: false

    - name: Show cluster information
      debug:
        msg: |
          ========================================
          Cluster Setup Complete!
          ========================================
          {{ cluster_status.stdout }}
          ========================================
          
          ðŸš€ DASHBOARD: http://{{ ansible_host }}:30000/c/main/token