---
# =============================================================================
# Common Role: Tasks run on ALL nodes (masters and workers)
# =============================================================================
# This role prepares all nodes with:
# - System updates
# - Hostname configuration
# - /etc/hosts configuration
# - Swap disable
# - Kernel modules
# - Sysctl parameters
# - Container runtime (containerd)
# - Kubernetes packages (kubeadm, kubelet, kubectl)
# =============================================================================

- name: Display node information
  debug:
    msg: "Configuring {{ inventory_hostname }} ({{ node_role }})"

- name: Create log directory
  file:
    path: "{{ log_dir }}"
    state: directory
    mode: '0755'

# =============================================================================
# 1. System Updates and Basic Configuration
# =============================================================================

- name: Update apt cache
  apt:
    update_cache: yes
    cache_valid_time: 3600
  retries: "{{ package_install_retries }}"
  delay: "{{ package_install_delay }}"

- name: Upgrade all packages
  apt:
    upgrade: dist
    autoremove: yes
    autoclean: yes
  retries: "{{ package_install_retries }}"
  delay: "{{ package_install_delay }}"

- name: Set hostname
  hostname:
    name: "{{ inventory_hostname }}"

# =============================================================================
# 2. Configure /etc/hosts
# =============================================================================

- name: Build /etc/hosts content for leader master
  set_fact:
    hosts_content: |
      127.0.0.1 localhost {{ load_balancer_dns }}
      {% for host in groups['masters'] %}
      {{ hostvars[host]['private_ip'] }} {{ host }}
      {% endfor %}
      {% for host in groups['workers'] %}
      {{ hostvars[host]['private_ip'] }} {{ host }}
      {% endfor %}
      
      # IPv6
      ::1 ip6-localhost ip6-loopback
      fe00::0 ip6-localnet
      ff00::0 ip6-mcastprefix
      ff02::1 ip6-allnodes
      ff02::2 ip6-allrouters
      ff02::3 ip6-allhosts
  when: inventory_hostname == groups['masters'][0]

- name: Build /etc/hosts content for non-leader nodes
  set_fact:
    hosts_content: |
      127.0.0.1 localhost
      {{ hostvars[groups['masters'][0]]['private_ip'] }} {{ groups['masters'][0] }} {{ load_balancer_dns }}
      {% for host in groups['masters'][1:] %}
      {{ hostvars[host]['private_ip'] }} {{ host }}
      {% endfor %}
      {% for host in groups['workers'] %}
      {{ hostvars[host]['private_ip'] }} {{ host }}
      {% endfor %}
      
      # IPv6
      ::1 ip6-localhost ip6-loopback
      fe00::0 ip6-localnet
      ff00::0 ip6-mcastprefix
      ff02::1 ip6-allnodes
      ff02::2 ip6-allrouters
      ff02::3 ip6-allhosts
  when: inventory_hostname != groups['masters'][0]

- name: Configure /etc/hosts
  copy:
    content: "{{ hosts_content }}"
    dest: /etc/hosts
    owner: root
    group: root
    mode: '0644'

# =============================================================================
# 3. Disable Swap
# =============================================================================

- name: Disable swap immediately
  command: swapoff -a
  when: swap_disabled | bool

- name: Disable swap permanently in /etc/fstab
  replace:
    path: /etc/fstab
    regexp: '^([^#].*?\sswap\s+sw\s+.*)$'
    replace: '# \1'
  when: swap_disabled | bool

# =============================================================================
# 4. Load Kernel Modules
# =============================================================================

- name: Create kernel modules configuration file
  copy:
    dest: /etc/modules-load.d/k8s.conf
    content: |
      overlay
      br_netfilter
    owner: root
    group: root
    mode: '0644'

- name: Load overlay module
  modprobe:
    name: overlay
    state: present

- name: Load br_netfilter module
  modprobe:
    name: br_netfilter
    state: present

# =============================================================================
# 5. Configure Sysctl Parameters
# =============================================================================

- name: Configure sysctl parameters for Kubernetes
  sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    state: present
    sysctl_file: /etc/sysctl.d/k8s.conf
    reload: yes
  loop:
    - { name: 'net.bridge.bridge-nf-call-iptables', value: '1' }
    - { name: 'net.bridge.bridge-nf-call-ip6tables', value: '1' }
    - { name: 'net.ipv4.ip_forward', value: '1' }

# =============================================================================
# 6. Install Containerd
# =============================================================================

- name: Install required packages for containerd
  apt:
    name:
      - apt-transport-https
      - ca-certificates
      - curl
      - gnupg
      - lsb-release
    state: present
  retries: "{{ package_install_retries }}"
  delay: "{{ package_install_delay }}"

- name: Create keyrings directory
  file:
    path: /etc/apt/keyrings
    state: directory
    mode: '0755'

- name: Add Docker GPG key
  apt_key:
    url: https://download.docker.com/linux/ubuntu/gpg
    keyring: /etc/apt/keyrings/docker.gpg
    state: present

- name: Add Docker repository
  apt_repository:
    repo: "deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.gpg] {{ docker_apt_repository }} {{ ansible_distribution_release }} stable"
    state: present
    filename: docker

- name: Install containerd
  apt:
    name: containerd.io
    state: present
    update_cache: yes
  retries: "{{ package_install_retries }}"
  delay: "{{ package_install_delay }}"

# =============================================================================
# 7. Configure Containerd
# =============================================================================

- name: Create containerd configuration directory
  file:
    path: /etc/containerd
    state: directory
    mode: '0755'

- name: Generate default containerd configuration
  shell: containerd config default > /etc/containerd/config.toml
  args:
    creates: /etc/containerd/config.toml

- name: Configure containerd for Kubernetes 1.33 compatibility
  ansible.builtin.template:
    src: containerd-config.toml.j2
    dest: /etc/containerd/config.toml
    owner: root
    group: root
    mode: '0644'
  notify: restart containerd

- name: Enable and start containerd service
  systemd:
    name: containerd
    enabled: yes
    state: started
    daemon_reload: yes

# =============================================================================
# 8. Install Kubernetes Packages
# =============================================================================

- name: Add Kubernetes GPG key
  apt_key:
    url: https://pkgs.k8s.io/core:/stable:/v{{ kubernetes_version }}/deb/Release.key
    keyring: /etc/apt/keyrings/kubernetes-apt-keyring.gpg
    state: present

- name: Add Kubernetes repository
  apt_repository:
    repo: "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] {{ kubernetes_apt_repository }} /"
    state: present
    filename: kubernetes

- name: Install Kubernetes packages
  apt:
    name:
      - kubelet={{ kubernetes_version_full }}
      - kubeadm={{ kubernetes_version_full }}
      - kubectl={{ kubernetes_version_full }}
    state: present
    update_cache: yes
  retries: "{{ package_install_retries }}"
  delay: "{{ package_install_delay }}"

- name: Hold Kubernetes packages at current version
  dpkg_selections:
    name: "{{ item }}"
    selection: hold
  loop:
    - kubelet
    - kubeadm
    - kubectl

- name: Enable kubelet service
  systemd:
    name: kubelet
    enabled: yes
    daemon_reload: yes

# =============================================================================
# 9. Install AWS CLI (for S3 bootstrap artifacts)
# =============================================================================

- name: Install AWS CLI
  apt:
    name: awscli
    state: present
  retries: "{{ package_install_retries }}"
  delay: "{{ package_install_delay }}"

- name: Node preparation complete
  debug:
    msg: "Node {{ inventory_hostname }} is ready for Kubernetes installation"