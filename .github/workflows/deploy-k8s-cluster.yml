name: Deploy HA Kubernetes Cluster

on:
  workflow_dispatch:
    inputs:
      master_count:
        type: choice
        options: ['3', '5']
        default: '3'
        description: "Number of Kubernetes masters"

      worker_count:
        type: choice
        options: ['1','2','3','4','5']
        default: '2'
        description: "Number of Kubernetes workers"

      master_instance_type:
        type: choice
        options: ['t3.micro', 't3.small']
        default: 't3.small'
        description: "Master instance type"

      worker_instance_type:
        type: choice
        options: ['t3.micro', 't3.small']
        default: 't3.small'
        description: "Worker instance type"  

      aws_region:
        type: choice
        options: ['us-east-1', 'us-west-2', 'eu-central-1']
        default: 'us-east-1'
        description: "AWS deployment region"

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ inputs.aws_region }}
          role-to-assume: arn:aws:iam::919586551447:role/GitHubActionsKubernetesRole  

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.0

      - name: Terraform Init & Apply
        env:
          AWS_DEFAULT_REGION: ${{ inputs.aws_region }}
        run: |
          terraform init -upgrade

          terraform apply -auto-approve -input=false \
            -var="master_count=${{ inputs.master_count }}" \
            -var="worker_count=${{ inputs.worker_count }}" \
            -var="master_instance_type=${{ inputs.master_instance_type }}" \
            -var="worker_instance_type=${{ inputs.worker_instance_type }}" \
            -var="region=${{ inputs.aws_region }}"

      - name: Generate Ansible Inventory
        run: |
          cd ansible
          chmod +x generate-inventory.sh
          ./generate-inventory.sh ".."

      - name: Setup SSH Key for Ansible
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.K8S_CLUSTER_PRIVATE_KEY }}" > ~/.ssh/k8s-cluster-key.pem
          chmod 600 ~/.ssh/k8s-cluster-key.pem

      - name: Install Ansible
        run: |
          python3 -m pip install --user ansible boto3 botocore
          ansible-galaxy collection install community.general ansible.posix

      - name: Run Ansible Playbook
        working-directory: ./ansible
        env:
          ANSIBLE_HOST_KEY_CHECKING: "false"
          ANSIBLE_STDOUT_CALLBACK: ansible.builtin.default
          ANSIBLE_DISPLAY_OK_HOSTS: "true"
          ANSIBLE_DISPLAY_SKIPPED_HOSTS: "true"
        run: |
          ansible-playbook -i inventory/hosts.ini playbooks/site.yml

      - name: Success
        run: |
          echo "âœ… Cluster deployed Successfully!"
